package unirio.pm.gpx.parser;
import unirio.pm.gpx.model.Track;
import unirio.pm.gpx.model.TrackPoint;
import unirio.pm.gpx.model.TrackSegment;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.text.DecimalFormat;
import java.text.DecimalFormatSymbols;
import java.util.List;
import java.util.Locale;

public class WriteGPX {

	//Create XML header
	private static final String xml_header = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\" ?>";
	//Create GPX opening tag
	private static final String tag_gpx = "<gpx creator=\"LoadMyTracks/045 http://www.cluetrust.com/LoadMyTracks.html\"" + 
										"version=\"1.1\" xmlns=\"http://www.topografix.com/GPX/1/1\"" +
										"xmlns:geocache=\"http://www.groundspeak.com/cache/1/0\"" +
										"xmlns:gpxdata=\"http://www.cluetrust.com/XML/GPXDATA/1/0\"" +
										"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" " +
										"xsi:schemaLocation=\"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" +
										"http://www.cluetrust.com/XML/GPXDATA/1/0 http://www.cluetrust.com/Schemas/gpxdata10.xsd\">";
	// Writes the GPX file
	public static void writeFile(List<GPXPath> cTrackPoints, File target)
			throws IOException {
		FileWriter fw = new FileWriter(target);

		fw.write(xml_header + "\n");
		fw.write(tag_gpx + "\n");

		for (GPXPath gpxPath : cTrackPoints) {
			writeTrackPoints(fw, gpxPath);
		}

		fw.write("</gpx>");

		fw.close();
	}

	/**
	 * Iterates on track points and write them.
	 * 
	 * @param trackName
	 *            Name of the track (metadata).
	 * @param fw
	 *            Writer to the target file.
	 * @param c
	 *            Cursor to track points.
	 * @throws IOException
	 */
	public static void writeTrackPoints(FileWriter fw, GPXPath gpxPath)
			throws IOException {
		fw.write("\t" + "<trk>");
		fw.write("\t\t" + "<name>" + gpxPath.getName() + "</name>" + "\n");

		fw.write("\t\t" + "<trkseg>" + "\n");

		List<Point> points = gpxPath.getPoints();
		for (Point point : points) {
			StringBuffer out = new StringBuffer();
			out.append("\t\t\t" + "<trkpt lat=\"" + df.format(point.getLat())
					+ "\" " + "lon=\"" + df.format(point.getLon()) + "\">");
			out.append("<ele>" + df.format(point.getZ()) + "</ele>");
			out.append("<time>" + POINT_DATE_FORMATTER.print(point.getTime())
					+ "</time>");
			 out.append("<extensions><gpxx:Depth>8</gpxx:Depth></extensions>");
			out.append("</trkpt>" + "\n");
			fw.write(out.toString());
		}

		fw.write("\t\t" + "</trkseg>" + "\n");
		fw.write("\t" + "</trk>" + "\n");
	}

}

